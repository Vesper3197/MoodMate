{% extends 'layout.html'%} <!-- ç»§æ‰¿è‡ª layout.html æ¨¡æ¿ -->

{%block style%}
<!-- åœ¨æ­¤å—ä¸­å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='styles/chat.css') }}"
/>
{%endblock style%}

{% block content%}
<style>
  .chat-area {
    background-image: url('{{ url_for("static", filename="images/picture3.jpg") }}');
    background-size: cover; /* è®©èƒŒæ™¯å›¾ç‰‡å¡«å……æ•´ä¸ªèŠå¤©æ¡† */
    background-position: center; /* å›¾ç‰‡å±…ä¸­æ˜¾ç¤º */
    background-repeat: no-repeat; /* é˜²æ­¢å›¾ç‰‡é‡å¤ */
    background-size: 70%; /* å°†èƒŒæ™¯å›¾ç‰‡ç¼©å°åˆ° 50% */
    width: 100%; /* ç¡®ä¿å®½åº¦å¡«æ»¡ */
    height: 100%; /* ç¡®ä¿é«˜åº¦å¡«æ»¡ */
  }
  
</style>

<!-- èŠå¤©é¡µé¢çš„ä¸»ä½“å†…å®¹å— -->
<div id="chatbot" class="chatbot">
  <div id="chatbot-profile" class="chatbot-profile">
    <!-- èŠå¤©æœºå™¨äººå¤´åƒå’Œä¿¡æ¯åŒºåŸŸ -->
    <img
      src="{{url_for('static',filename='images/picture2.jpg')}}"
      id="chatbot-image"
      class="rounded-circle border border-secondary my-4 mx-auto d-block"
      style="width: 15.625rem; height: 15.625rem"
    />
    <!-- æ˜¾ç¤ºæœºå™¨äººå¤´åƒ -->
    <div class="container d-grid gap-3 px-5">
      <!-- æŒ‰é’®å’Œå¼€å‘è€…ä¿¡æ¯ -->
      <a
        class="btn btn-outline-info btn-lg"
        href="{{url_for('main.about')}}"
      >
        About usğŸ¤–
      </a>
      <!-- å…³äºæŒ‰é’®ï¼Œè·³è½¬åˆ°å…³äºé¡µé¢ -->
      <button type="button" class="btn btn-lg btn-info" data-bs-toggle="popover" data-bs-title="Help" data-bs-placement="top" data-bs-content="Start the conversation by typing a greeting or ask a question (E.g. What is Mental Health, What is the cause of depression). You can also select a specific topic, test or exercise through the tab above the text input box. Having trouble with the chatting? Avoid typo as this chatbot has built-in autocorrector, thank you!">Need Help?</button>
      <!-- "Need Help?" æŒ‰é’®ï¼Œæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ -->
      <button type="button" class="btn btn-lg btn-info" data-bs-toggle="popover" data-bs-title="Subject List" data-bs-placement="bottom" data-bs-content="Topics I discuss include mental health, addiction, anxiety, depression, psychological disorders, mood management, loneliness, substance abuse, meditation, mindfulness, personal growth, phobias, self-care, sleep quality, stress coping, suicide prevention, and trauma treatment.">Subject</button>
      <!-- "Subject" æŒ‰é’®ï¼Œæ˜¾ç¤ºè¯é¢˜åˆ—è¡¨ -->
    
      <!-- æ˜¾ç¤ºå¼€å‘è€…ä¿¡æ¯ -->
    </div>
  </div>
  
  <div class="chat-area">
    <main id="main-chat" class="main-chat">
      <!-- èŠå¤©åŒºåŸŸ -->
      {% if current_user.is_authenticated and messages %}
        <!-- å¦‚æœç”¨æˆ·å·²ç™»å½•å¹¶ä¸”æœ‰æ¶ˆæ¯ -->
        {%for message in messages%}
          {%if message.sender == 'user'%}
            <!-- å¦‚æœæ¶ˆæ¯æ˜¯ç”¨æˆ·å‘é€çš„ -->
            <div class="chat right-msg">
              <img src="{{url_for('static',filename='profile_images/default.jpg')}}" class="chat-image"/>
              <div class="chat-bubble">
                <div class="chat-info">
                  <div class="chat-info-name">You</div>
                  <!-- æ˜¾ç¤ºç”¨æˆ·åå­— -->
                  <div class="chat-info-time">{{message.timestamp.strftime('%d/%m/%Y, %H:%M')}}</div>
                  <!-- æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´ -->
                </div>
                <div class="chat-text">
                  {{message.message}}
                  <!-- æ˜¾ç¤ºç”¨æˆ·å‘é€çš„æ¶ˆæ¯ -->
                </div>
              </div>
            </div>
          {%else%}
            <!-- å¦‚æœæ¶ˆæ¯æ˜¯èŠå¤©æœºå™¨äººå‘é€çš„ -->
            <div class="chat left-msg">
              <img src="{{url_for('static',filename='images/picture2.jpg')}}" class="chat-image"/>
              <div class="chat-bubble">
                <div class="chat-info">
                  <div class="chat-info-name">MoodMate</div>
                  <!-- æ˜¾ç¤ºèŠå¤©æœºå™¨äººåå­— -->
                  <div class="chat-info-time">{{message.timestamp.strftime('%d/%m/%Y, %H:%M')}}</div>
                  <!-- æ˜¾ç¤ºæ¶ˆæ¯æ—¶é—´ -->
                </div>
                <div class="chat-text">
                  {{message.message}}
                  <!-- æ˜¾ç¤ºèŠå¤©æœºå™¨äººå‘é€çš„æ¶ˆæ¯ -->
                </div>
              </div>
            </div>
          {%endif%}
        {%endfor%}
        <hr>
      {%endif%}
      <!-- å¦‚æœç”¨æˆ·å·²ç™»å½•å¹¶ä¸”æœ‰æ¶ˆæ¯ï¼Œå¾ªç¯æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ -->
      <p class="text-muted text-center mb-2">Today</p>
      <!-- æ˜¾ç¤ºä»Šå¤©çš„æ—¥æœŸæ ‡ç­¾ -->
      
      <div class="chat left-msg">
        <img src="{{url_for('static',filename='images/picture2.jpg')}}" class="chat-image"/>
        <div class="chat-bubble">
          <div class="chat-info">
            <div class="chat-info-name">MoodMate</div>
            <div class="chat-info-time">**:**</div>
            <!-- é»˜è®¤æ—¶é—´æ ¼å¼ -->
          </div>
          {%if current_user.is_authenticated%}
            <!-- å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºä¸ªæ€§åŒ–çš„æ¬¢è¿æ¶ˆæ¯ -->
            <div class="chat-text">
              Please do understand that this is a chatbot and not a real person, please don't substitute this for real help.
              <br><br>
              Always best to seek professional help if you are in need of it.
              <br><br>
              With that said,
              <br>
              Hi {{current_user.username}}, welcome back to MoodMate! Go ahead and send me a message. ğŸ˜„ 
            </div>
          {%else%}
            <!-- å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºé€šç”¨æ¬¢è¿æ¶ˆæ¯ -->
            <div class="chat-text">
              Hello, welcome to MoodMate! Go ahead and send me a message. ğŸ˜„
              <br><br>
              Please do understand that this is a chatbot and not a real person, please don't substitute this for real help.
              <br><br>
              Always best to seek professional help if you are in need of it.
            </div>
          {%endif%}
        </div>
      </div>
    </main>
    
    <script>
      let element = document.getElementById("main-chat");
      setTimeout(() => {
        element.scrollTop = element.scrollHeight;
      }, 100); 
      <!-- è‡ªåŠ¨æ»šåŠ¨åˆ°èŠå¤©åŒºåŸŸçš„åº•éƒ¨ -->
    </script>

    <div>
      <!-- å·¥å…·åŒº -->
      <div class="tools border-top border-info gap-3">
        <!-- è¯­è¨€é€‰æ‹©ä¸‹æ‹‰èœå• -->
        <div class="btn-group dropup">
          <label for="languageSelect">Select Language ğŸŒ:</label>
            <select id="languageSelect" class="form-select" style="display: inline-block; width: auto; margin-left: 10px;">
              <option value="en-US">English</option>
              <option value="zh-CN">ä¸­æ–‡</option>
            </select>
        </div>

      </div>
      
      
      <form id="message-form" class="chat-inputarea">
        <!-- æ¶ˆæ¯è¾“å…¥è¡¨å• -->
        <input type="hidden" name="source" value="voice_chat" />
        <input
          type="text"
          class="chat-input"
          id="textInput"
          name="msg"
          autocomplete="off"
          placeholder="Enter your message..."
          style="display:none"
        /><!-- å‘é€æŒ‰é’® -->
        <button type="submit" class="btn btn-outline-info" style="display:none">Send</button>

        <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
        <button type="button" id="voiceInputBtn" class="btn btn-outline-info">
          ğŸ¤ Start Speaking
        </button>
        
      </form>
      
    </div>
  </div>

<script>
  //è¯­éŸ³è½¬æ–‡æœ¬
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRecognition ? new SpeechRecognition() : null;
  if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.continuous = false; // è®¾ç½®ä¸º true ä¼šè¯†åˆ«è¿ç»­çš„è¯­éŸ³è¾“å…¥
    recognition.interimResults = true; // æ˜¾ç¤ºéƒ¨åˆ†ç»“æœ

    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const messageForm = document.getElementById("message-form");
    const textInput = document.getElementById('textInput');
    const languageSelect = document.getElementById('languageSelect');

    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
    voiceInputBtn.addEventListener('click', () => {
      if (!recognition) {
        alert("Your browser doesn't support Speech Recognition. Please use Chrome or Edge.");
        return;
      }

      // è®¾ç½®è¯†åˆ«è¯­è¨€ä¸ºé€‰æ‹©æ¡†çš„å½“å‰å€¼
      recognition.lang = languageSelect.value;

      recognition.start();
      voiceInputBtn.innerHTML = 'ğŸ™ï¸ Listening...'; // æ”¹å˜æŒ‰é’®å›¾æ ‡ä¸ºå½•éŸ³ä¸­
      voiceInputBtn.setAttribute('disabled', true); // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    });

    // å½“è¯†åˆ«åˆ°è¯­éŸ³æ—¶
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript; // è·å–è¯†åˆ«åˆ°çš„æ–‡æœ¬
      textInput.value = transcript; // å¡«å…¥æ–‡æœ¬æ¡†
    };

    // è¯­éŸ³è¯†åˆ«ç»“æŸåæ¢å¤æŒ‰é’®çŠ¶æ€
    recognition.onend = function() {
      voiceInputBtn.innerHTML = 'ğŸ¤ Start Speaking'; // æ¢å¤æŒ‰é’®å›¾æ ‡
      voiceInputBtn.removeAttribute('disabled'); // æ¢å¤æŒ‰é’®å¯ç‚¹å‡»

      messageForm.requestSubmit();
    };

    // é”™è¯¯å¤„ç†
    recognition.onerror = function(event) {
      console.error("Speech recognition error: " + event.error);
      voiceInputBtn.innerHTML = 'ğŸ¤'; // å¦‚æœæœ‰é”™è¯¯ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
      voiceInputBtn.removeAttribute('disabled');
    };

  } else {
    console.log("Your browser does not support SpeechRecognition.");
    // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œå¯ä»¥åœ¨æ­¤å¤„æä¾›ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆæˆ–æç¤º
  }

  // è¡¨å•æäº¤é€»è¾‘
  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const userMessage = textInput.value;

    const response = await fetch("/voice_chat_messages", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ msg: userMessage }),
    });

    const data = await response.json();
    // æ˜¾ç¤ºå“åº”ï¼ˆå¯ä»¥æ›´æ–° DOMï¼‰
    console.log(data.msg);
  });
</script>
 

  {%include "chat/send_function.html"%}
  <!-- åŒ…å«å‘é€æ¶ˆæ¯çš„åŠŸèƒ½ -->

{%endblock content%}
